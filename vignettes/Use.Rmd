---
title: "Kin estimation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, comment = "#>"
)
# library(DemoKin)
devtools::load_all()
library(tidyverse)
library(DiagrammeR)
```

My ego has 35 years and she is in 1995. She and all her relatives had lived in Sweden. We would like to know how many relatives ego has in 1995, their mean age, how many had at each age until now.

We can estimate this in a **stable** framework using data from 1995, assuming all relatives would experience mortality and fertility from that calendar year (Caswell, 2019). The package has available data from Sweden (*swe_surv*, *swe_asfr* and *swe_pop*, for survival, fertility and population), loaded using *get_HMDHFD* function.

```{r}
swe30_1950_stable <- kins(ego_age = 35, year = 2015,
                             P = swe_surv, asfr = swe_asfr,
                             stable = TRUE)
```

Let´s visualize their distribution during ego´s life.

```{r, fig.height=6, fig.width=8}
swe30_1950_stable[["kins_by_age_ego"]] %>%
              gather(kin, count, -x) %>%
              ggplot() +
              geom_line(aes(x, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)
```

Now let´s visualize their age distribution when ego is 35 (age valuation).

```{r, fig.height=6, fig.width=8}
swe30_1950_stable[["kins_by_age_kin"]] %>%
              select(-x) %>% 
              gather(kin, count, -x_kin) %>%
              ggplot() +
              geom_line(aes(x_kin, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)
```

Now let´s see same results considering time variant components. The formula for example for Great-grandmothers (*ggm*), being *x* mother´s age at ego´s birth, *y* grandmother´s age at ego´s mother birth and *z* Great-grandmother´s age until ego´s birth:

$$ ggm(0,t) = \sum_{x=0}^{\omega}{W(x,t-x)
              \sum_{y=0}^{\omega}{W(y,t-x-y)
              \prod_{z=0}^{x+y-1}{p(z,t-x-y+z)}}}$$

Let´s take a look (taking too long by now):

```{r}
swe30_1950_nonstable <- kins(ego_age = 35, year = 2015,
                             P = swe_surv, asfr = swe_asfr, N = swe_pop,
                             stable = FALSE)
```

```{r, fig.height=6, fig.width=8}
swe30_1950_nonstable[["kins_by_age_kin"]] %>%
              select(-x) %>% 
              gather(kin, count, -x_kin) %>%
              ggplot() +
              geom_line(aes(x_kin, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)
```

Finally we can visualize counts in ego´s network, for the first case, rounded on 3 digits by default.

```{r, fig.height=6, fig.width=8}
plot_diagramm(swe30_1950_stable[["kins_total"]],ego_age = 35)
```

