---
title: "Expected kin count by type of relative: A matrix implementation"
output: 
  html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Use}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
devtools::load_all()
library(tidyverse)
library(DiagrammeR)
library(knitr)
library(progress)
```

The year is 2015 and focal is 35 years old^[Age should be understood as a class state, defined in a matrix transition framework.]. Focal and her relatives have all lived in Sweden. 
We would like to know how many female relatives focal has in 2015, their mean age and the number of living kin at each age of focal. Finally, we would like to know at which age she had to suffer a death in average.

## Kin counts with time invariant rates

We can estimate this in a **stable** framework using data from 2015, assuming that all of focal's relatives experience mortality and fertility from that calendar year (Caswell, 2019). The `DemoKin` package includes data from Sweden as an example (*swe_px*, *swe_Sx*, *swe_asfr* and *swe_pop*, matrix of age by year, with survival probability, survival ratio, fertility and population; type `data(package="DemoKin")`). This data comes from the [Human Mortality Database](https://www.mortality.org/) and [Human Fertility Database](https://www.humanfertility.org/). These datasets were loaded using the`get_HMDHFD` function. 

```{r}
swe_surv_2015 <- swe_px[,"2015"]
swe_asfr_2015 <- swe_asfr[,"2015"]
swe_2015 <- kin(U = swe_surv_2015, f = swe_asfr_2015, time_invariant = TRUE)
```

Let's visualize the distribution of relatives over focal's lifecourse:

```{r, fig.height=6, fig.width=8}
swe_2015[["kin_summary"]] %>%
              ggplot() +
              geom_line(aes(age_focal, count))  +
              theme_bw() +
              facet_wrap(~kin)
```

Where each relative type is identified by a unique code:

```{r, fig.height=6, fig.width=8, echo=FALSE}

relatives <- c(
  "coa" = "Cousins (through aunt older than mother)"
  , "cya" = "Cousins (through aunt younger than mother)"
  , "d" = "Daughter"
  , "gd" = "Grand-daughter"
  , "ggm" = "Great-grandmother"
  , "gm" = "Grandmother"
  , "m" = "Mother"
  , "nos" = "Nieces through older sister"
  , "nys" = "Nieces through younger sister"
  , "oa" = "Aunt older than mother"
  , "ya" = "Aunt younger than mother"
  , "os" = "Older sister"
  , "ys" = "Younger sister"
  )

data.frame(Code = names(relatives), Relative = relatives, row.names = NULL) %>% kable()

```

We can also visualize the age distribution of relatives when focal is 35 for example:

```{r, fig.height=6, fig.width=8}
swe_2015[["kin_full"]] %>%
              filter(age_focal == 35) %>% 
              ggplot() +
              geom_line(aes(age_kin, count))  +
              theme_bw() +
              facet_wrap(~kin)
```

The function assumes that fertility input is for both sex, so in case this is only for one you need to set `birth_female = 1` in a convenient way. In the case you are using survival rates ($S_x$) instead of probabilities ($p_x$), fertility vectors should consider the adaptation for person-year exposure on females: $(\frac{f_x+f_{x+1}S_x}{2})\frac{L_0}{l_0}$ instead of only $fx$ (Preston et.al, 2002).

The `kin` function also includes a summary output with the count of living kin, mean and standard deviation of kin age, by type of kin, for each focal's age:

```{r, fig.height=6, fig.width=8}
swe_2015[["kin_summary"]] %>% 
  filter(age_focal == 35) %>% 
  select(kin, count, mean_age, sd_age) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  kable()
```

We can visualize the estimated kin counts by type of kin using a network diagram. Following with the age 35:

```{r}
swe_2015_age35 <- swe_2015[["kin_summary"]] %>% 
                filter(age_focal == 35) %>% 
                select(kin, count)
plot_diagram(swe_2015_age35)
```


## Kin counts with time varying rates

The demographic risks of population of Sweden is, in reality, changin every year, and focal relatives have been expossed to changing mortality and fertility rates.
To account for this, is needed estimations of kin counts in population with time-variant demographic rates. Let's take a look at the resulting kin counts for 1960 cohort, for some specific types:

```{r, fig.height=6, fig.width=8}
swe_2015_time_varying <- kin(U = swe_px, f = swe_asfr, N = swe_pop, time_invariant =FALSE,
                                    output_cohort = 1960,
                                    output_kin = c("d","gd","ggd","m","gm","ggm"))

swe_2015_time_varying$kin_full %>%
  group_by(kin, cohort, age_focal) %>% summarise(count = sum(count)) %>%
  ggplot(aes(age_focal,count,color=factor(cohort))) +
  scale_y_continuous(name = "",labels = seq(0,3,.2),breaks = seq(0,3,.2))+
  geom_line(size=1,color=1)+
  geom_vline(xintercept = 35, color=2)+
  facet_wrap(~kin,scales = "free")+
  theme_bw()

```

As you see the estimates stop at age 55, because no data is after 2015.

## Death Experience

Kin loss has studied consequences related to mental health, care support and household incomes over life course. Setting the parameter `alive="no"` we can see for a focal from 1900 cohort how many relatives loss during her life (output `kin_death_by_age_focal`):

```{r, fig.height=6, fig.width=8}
swe_1900_time_varying <- kin(U = swe_px, f = swe_asfr, N = swe_pop, time_invariant = FALSE,
                                    output_cohort = 1900,
                                    output_kin = c("d","gd","ggd","m","gm","ggm"),
                             living = FALSE)

swe_1900_time_varying$kin_summary %>%
  filter(alive =="no") %>%
  ggplot() +
  geom_line(aes(age_focal, count_cum))  +
  theme_bw() +
  facet_wrap(~kin,scales="free")
```

Given some portion of each relative was dead (remember we are talking about population measures), we can ask what was the mean age at lost for each kin, when focal was 50:

```{r}
swe_1900_time_varying$kin_summary %>% 
  filter(alive=="no", age_focal == 50) %>% 
  select(kin,count_cum,mean_age_lost) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  kable()
```

## Prevalences

Once you have a full kin distribution by age, is possible to know, for example given a set of prevalence by age, what is the expected portion of living kin in each prevalence state (could be disease, employment, etc.). 

```{r}
# let´s create some prevalence shcedule by age
swe_2015_prevalence <- tibble(age_kin = unique(swe_2015$kin_full$age_kin),
                              prev = .005 * exp(.05 * age_kin))

plot(swe_2015_prevalence)

# join to kin count estimates and plot
swe_2015$kin_full %>% 
  filter(alive=="yes") %>% 
  left_join(swe_2015_prevalence) %>% 
  group_by(kin, age_focal) %>% 
  summarise(prevalent = sum(count * prev),
            no_prevalent = sum(count * (1-prev))) %>% 
  pivot_longer(cols = prevalent:no_prevalent, names_to = "prevalence_state", values_to = "count") %>% 
  ggplot(aes(x=age_focal, y = count)) + 
  geom_area(aes(fill=prevalence_state)) +
  facet_wrap(~kin) +
  theme_bw()

```

This can be applied for time variant cases too. 

## References

Caswell, H. (2019). The formal demography of kinhip: A matrix formulation. Demographic Research 41:679–712. doi:10.4054/DemRes.2019.41.24.

Caswell, H., & Song, X. (2021). The formal demography of kinhip III: kinhip dynamics with time-varying demographic rates. Demographic Research, 45, 517–546.

Preston, S., Heuveline, P., & Guillot, M. (2000). Demography: Measuring and Modeling Population Processes. Wiley.
