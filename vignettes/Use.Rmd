---
title: "Expected kin count estimation by type"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
devtools::load_all()
library(tidyverse)
library(DiagrammeR)
```

Ego is 35 years old and she is in 1995. She and all her relatives had lived in Sweden. We would like to know how many reatives Ego has in 1995, their mean age and living kins at each age by type.

We can estimate this in a **stable** framework using data from 1995, assuming all relatives would experience mortality and fertility from that calendar year (Caswell, 2019). The package has already available data from Sweden (*swe_surv*, *swe_asfr* and *swe_pop*, for survival, fertility and population), loaded using *get_HMDHFD* function.

```{r}
swe35_2015_stable <- kins(ego_age = 35, year = 2015,
                             P = swe_surv, asfr = swe_asfr,
                             stable = TRUE)
```

Let´s visualize their distribution during ego´s life.

```{r, fig.height=6, fig.width=8}
swe35_2015_stable[["kins_by_age_ego"]] %>%
              gather(kin, count, -x) %>%
              ggplot() +
              geom_line(aes(x, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)
```

Now let´s visualize their age distribution when ego is 35 (age valuation), and the mean age:

```{r, fig.height=6, fig.width=8}
swe35_2015_stable[["kins_by_age_kin"]] %>%
              select(-x) %>% 
              gather(kin, count, -x_kin) %>%
              ggplot() +
              geom_line(aes(x_kin, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)

sort(round(swe35_2015_stable[["kins_mean_age"]],1))
```

Now let´s see same results considering time variant components. The basic formulas are weighting averages that depends on the distribution of ages at childbearing for ego´s ancestors. We can call *T* the year of ego´s birth and *W* the matrix of age (rows) by year (cols) of age at child-bearing, so the sum of each column is 1. For example for Great-grandmothers (*ggm*), being *x* mother´s age at ego´s birth, *y* grandmother´s age at ego´s mother birth, *z* Great-grandmother´s age at ego´s grandmother birth, and *i* her age until ego´s birth, the formula for initial Great-grandaughter at ego´s birth would be:

$$ ggm(0,T) = \sum_{x=0}^{\omega-1}{W(x,T-x)
              \sum_{y=0}^{\omega-1}{W(y,T-x-y)
              \sum_{z=0}^{\omega-1}{W(z,T-x-y-z)
              \prod_{i=z}^{x+y-1}{p(i,T-x-y-z+i)}}}}$$
              
This last (*ugly*) expression is implemented with loops and matrix algebra in the code (a matrix collapsed expression would be better here). Let´s take a look to results when ego is 35:

```{r, fig.height=6, fig.width=8}
swe35_2015_nonstable <- kins(ego_age = 35, year = 2015,
                             P = swe_surv, asfr = swe_asfr, N = swe_pop,
                             stable = FALSE)

swe35_2015_nonstable[["kins_by_age_kin"]] %>%
              select(-x) %>% 
              gather(kin, count, -x_kin) %>%
              ggplot() +
              geom_line(aes(x_kin, count))  +
              geom_vline(xintercept = 35, color=2)+
              theme_bw() +
              facet_wrap(~kin)
```

Finally we can visualize counts in ego´s network, for the stable case as an example, rounded on 3 digits by default.

```{r, fig.height=6, fig.width=8}
plot_diagramm(swe35_2015_stable[["kins_total"]],ego_age = 35)
```

